<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>update Image - AI Dataset Annotator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1 class="main-title">
            <i class="bi bi-pencil-square"></i> 
            <li>update Image label</li>
        </h1>

        <main>
            <nav aria-label="breadcrumb">
                <ul>
                    <li><a href="index.html"><i class="bi bi-house-door"></i> Home</a></li>
                    <li><a href="images.html"><i class="bi bi-images"></i> All Images</a></li>
                    <li>update Image label</li>
                </ul>
            </nav>

            <section class="card">
                <h2><i class="bi bi-image"></i> Image Preview</h2>
                <div id="image-preview" style="text-align: center; margin: 20px 0;">
                    <img id="preview-img" src="" alt="Image" style="max-width: 100%; max-height: 400px; border-radius: 8px;">
                </div>
                <p><strong>Filename:</strong> <span id="image-filename"></span></p>
                <p><strong>Upload Time:</strong> <span id="image-upload-time"></span></p>
            </section>

            <section class="card">
                <h2><i class="bi bi-card-text"></i> Update Description</h2>
                <form id="update-description-form">
                    <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea 
                            id="description" 
                            name="description" 
                            rows="4" 
                            placeholder="Enter image description..."
                        ></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Update Description
                    </button>
                </form>
            </section>

            <section class="card">
                <h2><i class="bi bi-tags"></i> Update Labels</h2>
                <div id="available-labels" class="label-list"></div>
                <button id="sync-labels-btn" class="btn btn-success" style="margin-top: 15px;">
                    <i class="bi bi-arrow-repeat"></i> Sync Labels
                </button>
            </section>

            <div id="result-message" class="alert" style="display: none;"></div>
        </main>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        const imageId = new URLSearchParams(window.location.search).get('id');

        let currentLabels = [];
        let allLabels = [];

        async function loadImageData() {
            try {
                const res = await fetch(`${API_BASE}/images/${imageId}`);
                const data = await res.json();
                
                document.getElementById('image-filename').textContent = data.image.filename;
                document.getElementById('image-upload-time').textContent = 
                    new Date(data.image.upload_time).toLocaleString();
                document.getElementById('description').value = data.image.description || '';
                document.getElementById('preview-img').src = `/uploads/${data.image.filename}`;

                currentLabels = data.labels.map(l => l.label_id);
                
            } catch (error) {
                console.error('Failed to load image:', error);
            }
        }

        async function loadAllLabels() {
            try {
                const res = await fetch(`${API_BASE}/labels`);
                const data = await res.json();
                allLabels = data.labels;
                renderLabels();
            } catch (error) {
                console.error('Failed to load labels:', error);
            }
        }

        function renderLabels() {
            const container = document.getElementById('available-labels');
            container.innerHTML = allLabels.map(label => `
                <label style="display: block; margin: 8px 0;">
                    <input 
                        type="checkbox" 
                        value="${label.id}" 
                        ${currentLabels.includes(label.id) ? 'checked' : ''}
                    >
                    ${label.name}
                </label>
            `).join('');
        }

        document.getElementById('update-description-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = document.getElementById('description').value;

            try {
                const res = await fetch(`${API_BASE}/images/${imageId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description })
                });

                const data = await res.json();
                showMessage(data.message, 'success');
            } catch (error) {
                showMessage('Failed to update description', 'error');
            }
        });

        document.getElementById('sync-labels-btn').addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('#available-labels input[type="checkbox"]');
            const label_ids = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => Number(cb.value));

            try {
                const res = await fetch(`${API_BASE}/images/${imageId}/sync-labels`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ label_ids })
                });

                const data = await res.json();
                showMessage(`${data.message} - ${data.labels.length} labels assigned`, 'success');
            } catch (error) {
                showMessage('Failed to sync labels', 'error');
            }
        });

        function showMessage(message, type) {
            const msgBox = document.getElementById('result-message');
            msgBox.textContent = message;
            msgBox.className = `alert alert-${type}`;
            msgBox.style.display = 'block';
            setTimeout(() => msgBox.style.display = 'none', 5000);
        }

        loadImageData();
        loadAllLabels();
    </script>
</body>
</html>
