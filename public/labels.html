<!DOCTYPE html>
<html lang="en">

<head>
    <title>Manage Labels - AI Dataset Annotation</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <h1 id="main-title" class="main-title">
            <i class="bi bi-tags"></i> Manage Labels
        </h1>

        <main>
            <nav aria-label="breadcrumb">
                <ul>
                    <li><a href="index.html"><i class="bi bi-house-door"></i> Home</a></li>
                    <li><a href="upload.html"><i class="bi bi-cloud-upload"></i> Upload Images</a></li>
                    <li><a href="labels.html"><i class="bi bi-tags"></i> Manage Labels</a></li>
                    <li><a href="images.html"><i class="bi bi-image"></i> View Images</a></li>
                </ul>
            </nav>

            <section class="card mb-5 shadow-sm">
                <div class="card-body p-4">
                    <p class="lead text-muted mb-4">
                        Create and manage labels for your dataset. Labels help categorize and organize your images for machine learning tasks.
                    </p>

                    <div class="label-form-section">
                        <h2><i class="bi bi-plus-circle"></i> Create New Label</h2>
                        <form id="create-form">
                            <div class="mb-3">
                                <label for="label-name" class="form-label">Label Name</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="label-name" 
                                    placeholder="Enter label name (e.g., cat, dog, car)" 
                                    required>
                            </div>
                            <button type="submit" class="btn btn-gradient-primary">
                                <i class="bi bi-plus-lg"></i> Create Label
                            </button>
                        </form>
                        <div id="create-status" class="status-message mt-3"></div>
                    </div>

                    <div class="existing-labels-section">
                        <h2 class="mb-4"><i class="bi bi-collection"></i> Existing Labels</h2>
                        <div id="list-status" class="status-message mb-3"></div>
                        <ul class="data-list" id="label-items"></ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">
                        <i class="bi bi-pencil"></i> Edit Label
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editLabelId">
                        <div class="mb-3">
                            <label for="editLabelName" class="form-label">Label Name</label>
                            <input type="text" class="form-control" id="editLabelName" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-gradient-primary" id="saveEditBtn">
                        <i class="bi bi-check-lg"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    const createForm = document.getElementById('create-form');
    const labelNameInput = document.getElementById('label-name');
    const createStatusEl = document.getElementById('create-status');
    const listEl = document.getElementById('label-items');
    const listStatusEl = document.getElementById('list-status');
    let editModal;

    document.addEventListener('DOMContentLoaded', () => {
        console.log('Page loaded, initializing...');
        editModal = new bootstrap.Modal(document.getElementById('editModal'));
        document.getElementById('saveEditBtn').addEventListener('click', saveEdit);
        loadLabels();
    });

    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = labelNameInput.value.trim();

        if (!name) {
            createStatusEl.innerHTML = '<div class="alert-danger"><i class="bi bi-exclamation-triangle"></i> Label name cannot be empty</div>';
            createStatusEl.className = 'status-message error';
            return;
        }

        console.log('Creating label:', name);
        createStatusEl.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';
        createStatusEl.className = 'status-message';

        try {
            const response = await fetch('/api/labels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to create label');
            }

            const data = await response.json();
            console.log('Label created successfully:', data);

            createStatusEl.innerHTML = '<div class="alert-success"><i class="bi bi-check-circle"></i> Label created successfully!</div>';
            createStatusEl.className = 'status-message success';
            labelNameInput.value = '';
            
            setTimeout(() => {
                createStatusEl.innerHTML = '';
            }, 3000);

            loadLabels();
        } catch (error) {
            console.error('Create label error:', error);
            createStatusEl.innerHTML = `<div class="alert-danger"><i class="bi bi-exclamation-triangle"></i> ${error.message}</div>`;
            createStatusEl.className = 'status-message error';
        }
    });

    async function loadLabels() {
        console.log('Loading labels...');
        listEl.innerHTML = '';
        listStatusEl.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
        listStatusEl.className = 'status-message';

        try {
            const response = await fetch('/api/labels');
            if (!response.ok) throw new Error('Failed to load labels');

            const data = await response.json();
            listStatusEl.innerHTML = '';

            if (!data.labels || data.labels.length === 0) {
                listStatusEl.innerHTML = '<div class="alert-info"><i class="bi bi-info-circle"></i> No labels created yet. Create your first label above!</div>';
                return;
            }

            listStatusEl.innerHTML = `<div class="label-count-badge">Total ${data.labels.length} labels</div>`;
            console.log('Labels loaded:', data.labels.length);

            for (const label of data.labels) {
                const item = document.createElement('li');
                item.className = 'data-item';
                
                const createdDate = new Date(label.created_time).toLocaleString();
                const labelInitial = label.name.charAt(0).toUpperCase();
                
                item.innerHTML = `
                    <div class="label-info">
                        <div class="label-badge">${labelInitial}</div>
                        <div class="label-details">
                            <span class="primary">${escapeHtml(label.name)}</span>
                            <span class="secondary">
                                <i class="bi bi-clock"></i> Created: ${createdDate}
                            </span>
                        </div>
                    </div>
                    <div class="label-actions">
                        <button class="btn btn-sm btn-gradient-secondary" data-action="edit" data-id="${label.id}" data-name="${escapeHtml(label.name)}">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" data-action="delete" data-id="${label.id}" data-name="${escapeHtml(label.name)}">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                `;
                listEl.appendChild(item);
            }
            
            attachButtonListeners();
            
        } catch (error) {
            console.error('Load labels error:', error);
            listStatusEl.innerHTML = '<div class="alert-danger"><i class="bi bi-exclamation-triangle"></i> Failed to load labels. Please check if the server is running.</div>';
            listStatusEl.className = 'status-message error';
        }
    }

    function attachButtonListeners() {
        document.querySelectorAll('[data-action="edit"]').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                openEditModal(id, name);
            });
        });
        
        document.querySelectorAll('[data-action="delete"]').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                deleteLabel(id, name);
            });
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function openEditModal(id, name) {
        console.log('Opening edit modal for label:', id, name);
        document.getElementById('editLabelId').value = id;
        document.getElementById('editLabelName').value = name;
        editModal.show();
    }

    async function saveEdit() {
        const id = document.getElementById('editLabelId').value;
        const name = document.getElementById('editLabelName').value.trim();

        console.log('Saving edit:', { id, name });

        if (!name) {
            alert('Label name cannot be empty');
            return;
        }

        try {
            const response = await fetch(`/api/labels/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to update label');
            }

            console.log('Label updated successfully');
            
            editModal.hide();
            loadLabels();
            
            listStatusEl.innerHTML = '<div class="alert-success"><i class="bi bi-check-circle"></i> Label updated successfully</div>';
            listStatusEl.className = 'status-message success';
            
            setTimeout(() => {
                listStatusEl.innerHTML = '';
            }, 3000);
        } catch (error) {
            console.error('Update error:', error);
            alert('Failed to update label: ' + error.message);
        }
    }

    async function deleteLabel(id, name) {
        console.log('Delete label requested:', id, name);
        
        if (!confirm(`Are you sure you want to delete label "${name}"?\n\nThis will remove the label from all associated images.`)) {
            console.log('Delete cancelled by user');
            return;
        }

        try {
            console.log('Sending delete request...');
            
            const response = await fetch(`/api/labels/${id}`, { 
                method: 'DELETE' 
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to delete label');
            }

            console.log('Label deleted successfully');
            
            loadLabels();
            
            listStatusEl.innerHTML = '<div class="alert-success"><i class="bi bi-check-circle"></i> Label deleted successfully</div>';
            listStatusEl.className = 'status-message success';
            
            setTimeout(() => {
                listStatusEl.innerHTML = '';
            }, 3000);
        } catch (error) {
            console.error('Delete error:', error);
            listStatusEl.innerHTML = `<div class="alert-danger"><i class="bi bi-exclamation-triangle"></i> Failed to delete label: ${error.message}</div>`;
            listStatusEl.className = 'status-message error';
        }
    }
    </script>
</body>
</html>